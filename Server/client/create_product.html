<!DOCTYPE html>
<html lang="en">

<!-- Mirrored from thevectorlab.net/flatlab/fb_wall.html by HTTrack Website Copier/3.x [XR&CO'2014], Fri, 14 Aug 2015 03:47:47 GMT -->
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="Mosaddek">
    <meta name="keyword" content="FlatLab, Dashboard, Bootstrap, Admin, Template, Theme, Responsive, Fluid, Retina">
    <link rel="shortcut icon" href="img/favicon.html">

    <title>FB Wall</title>

    <!-- Bootstrap core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-reset.css" rel="stylesheet">
    <!--external css-->
    <link href="https://cdn.jsdelivr.net/jquery.messagebox/latest/messagebox.css" rel="stylesheet" type="text/css">
    <link href="assets/font-awesome/css/font-awesome.css" rel="stylesheet" />
    <link rel="stylesheet" href="css/owl.carousel.css" type="text/css">
    <!-- Custom styles for this template -->
    <link href="css/style.css" rel="stylesheet">
    <link href="css/style-responsive.css" rel="stylesheet" />
    <link rel="stylesheet" type="text/css" href="css/gallery.css" />

  </head>

  <body>

    <section id="container" class="">
      <!--header start-->

      <!--header end-->

      <!--sidebar start-->

      <!--sidebar end-->

      <style>
        #drawing-mode {
          margin-bottom: 10px;
          vertical-align: top;
        }
        #drawing-mode-options {
          display: inline-block;
          vertical-align: top;
          margin-bottom: 10px;
          margin-top: 10px;
          background: #f5f2f0;
          padding: 10px;
        }
        label {
          display: inline-block; width: 130px;
        }
        .info {
          display: inline-block;
          width: 25px;
          background: #ffc;
        }
        #bd-wrapper {
          min-width: 1500px;
        }
        </style>

      <div id="drawing-mode-options">


        <div class="row">
                      <div class="col-xs-6">
                        <div class="btn-group chose_icon">
                            <button data-toggle="dropdown" class="btn btn-primary btn-round btn-danger dropdown-toggle choose_icon" type="button">
                                <i class="fa fa-smile-o"></i>
                                <span>Chọn icon</span> <span class="caret"></span>
                            </button>
                            <ul role="menu" class="dropdown-menu grid grid3 list_icon cs-style-3" style="height:auto;">

                            </ul>
                        </div>
                      </div>

                      <div class="col-xs-6">
                        <div class="btn-group choose_shirt">
                          <button data-toggle="dropdown" class="btn btn-primary btn-round btn-danger dropdown-toggle choose_shirt" type="button">
                            <i class="fa fa-smile-o"></i>
                            <span>Chọn Áo</span> <span class="caret"></span>
                          </button>
                          <ul role="menu" class="dropdown-menu grid grid3 list_shirt cs-style-3" style="height:auto;">
                            <li>
                              <img src="product/trang-mat-truoc.png" alt="img04" id="1">
                            </li>
                            <li>
                              <img src="product/trang-mat-sau.png" alt="img04" id="2">
                            </li>
                            <li>
                              <img src="product/den-mat-truoc.png" alt="img04" id="3">
                            </li>
                            <li>
                              <img src="product/den-mat-sau.png" alt="img04" id="4">
                            </li>
                          </ul>
                        </div>
                      </div>


                      <div class="col-xs-6">
                        <button type="button" class="btn btn-round btn-danger chose_delete">
                            <i class="fa fa-times"></i>
                            <span>Xóa</span>
                        </button>
                      </div>
                      <div class="col-xs-6">
                        <button type="button" id="create" class="btn btn-round btn-danger">
                            <i class="fa fa-plus"></i>
                            <span>Hoàn thành</span>
                        </button>
                      </div>
                    </div>
      </div>
    </div>
      <!--main content start-->
      <input type="file" class="iconimgLoader" style="display:none;">
          <div class="row">
            <canvas id="c1" width="400" height="500"></canvas>
          </div>
      <!--main content end-->
    </section>

    <!-- js placed at the end of the document so the pages load faster -->
    <script src="js/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/jquery.messagebox/latest/messagebox.min.js" type="text/javascript"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/fabric.min.js"></script>
    <script class="include" type="text/javascript" src="js/jquery.dcjqaccordion.2.7.js"></script>

    <script src="js/respond.min.js" ></script>

    <script src="js/modernizr.custom.js"></script>

    <!--right slidebar-->
    <script src="js/slidebars.min.js"></script>
    <script src="js/owl.carousel.js" ></script>
    <!--common script for all pages-->
    <script src="js/common-scripts.js"></script>

    <script>
        //owl carousel
        $(document).ready(function() {
            carousel = $("#owl-demo");
            carousel.owlCarousel({
                navigation : true,
                slideSpeed : 300,
                paginationSpeed : 400,
                singleItem : true,
                autoPlay:false,
                touchDrag: false,
                mouseDrag: false
            });

        });

        var userInfo = null;
        canvas1 = new fabric.Canvas('c1');
        var baseURL = 'http://192.168.1.79:3000/api';
        canvas1.setBackgroundImage('product/trang-mat-truoc.png', canvas1.renderAll.bind(canvas1), {
          width: canvas1.width,
          height: canvas1.height
        });
        var listSticker = [];
        var listShirt = baseURL.substring(0, baseURL.length - 3) + 'product/trang-mat-sau.png';

        $(window).load(function(){
          canvas1.renderAll();
        });


        $(".chose_delete").click(function(){
            canvas1.isDrawingMode = false;
            var activeObject = canvas1.getActiveObject(),
            activeGroup = canvas1.getActiveGroup();
            if (activeObject) {
                if (confirm('Bạn có chắc chắn xóa?')) {
                  for (var i = 0; i < listSticker.length; i++) {
                    if (listSticker[i].sticker_image == activeObject.getSrc().replace(/%20/g, " ")) {
                      listSticker.splice(i, 1);
                      break;
                    }
                  };
                  //alert(JSON.stringify(listSticker));
                  canvas1.remove(activeObject);
                }
            }
            else if (activeGroup) {
                if (confirm('Are you sure?')) {
                    var objectsInGroup = activeGroup.getObjects();
                    canvas1.discardActiveGroup();
                    objectsInGroup.forEach(function(object) {
                        canvas1.remove(object);
                    });
                }
            }
        });
        $(".choose_shirt li").click(function () {
          canvas1.isDrawingMode = false;
          url = $(this).find("img").attr("src");
          console.log(url);
          id = $(this).find("img").attr("id");
          var tempUrl = '';
          if (parseInt(id)%2 == 0) {
            console.log(id);
            tempUrl = $(".choose_shirt li img ")[parseInt(id) - 2];
            console.log($(tempUrl).attr('src'));
            listShirt = baseURL.substring(0, baseURL.length - 3) + $(tempUrl).attr('src');
            //console.log(listShirt);
          } else {
            tempUrl = $(".choose_shirt li img ")[parseInt(id)];
            console.log($(tempUrl).attr('src'));
            listShirt = baseURL.substring(0, baseURL.length - 3) + $(tempUrl).attr('src');
          }
          canvas1.setBackgroundImage(url, canvas1.renderAll.bind(canvas1), {
            width: canvas1.width,
            height: canvas1.height
          });
        });

        $(".choose_icon").click(function () {
          $(".list_icon").empty();

          (function () {
            if (WebViewBridge) {

              WebViewBridge.onMessage = function (message) {
                objectInfo = JSON.parse(message);
                //alert(message);
                var listIcon = [];
                $.ajax({
                  type: "GET",
                  url:  baseURL + '/Members/' + objectInfo.user_id  + '?filter[include]=products'
                }).done(function(member) {
                  member.products.forEach(function (product) {
                    if (typeof product.imgList != 'undefined') {
                      if (product.imgList.length == 1) {
                        listIcon.push(product);
                      }
                    }
                  });
                  //alert(JSON.stringify(listIcon));
                  listIcon.forEach(function (icon) {
                    $(".list_icon").append('<li><img alt="' + icon.price +'" crossOrigin="anonymous" src="' + icon.imgList[0] + '" id="' + icon.product_id +'"></li>');
                  });

                  $(".list_icon li").click(function(){
                    canvas1.isDrawingMode = false;
                    url = $(this).find("img").attr("src");
                    id = $(this).find("img").attr("id");
                    price = $(this).find("img").attr("alt");
                    listSticker.push({
                      product_id_1: objectInfo.product_id,
                      product_id_2: id,
                      sticker_image: url,
                      sticker_price: parseInt(price)
                    });
                    fabric.Image.fromURL(url, function(img) {
                      img.set({
                        left: canvas1.width / 4,
                        top: canvas1.height / 4,
                        angle: 0,
                        padding: 10,
                        cornersize: 10,
                        scaleY: canvas1.width / (img.width * 4),
                        scaleX: canvas1.width / (img.width * 4)
                      });
                      canvas1.add(img);
                    });
                  });

                });



                WebViewBridge.send("got the message inside webview");
              };

              WebViewBridge.send("hello from webview");
            }
          }());



        });


        $('.iconimgLoader').onchange = function handleImage(e) {
            var reader = new FileReader();
            reader.onload = function (event) {
                console.log('fdsf');
                var imgObj = new Image();
                imgObj.src = event.target.result;
                imgObj.onload = function () {
                    // start fabricJS stuff

                    var image = new fabric.Image(imgObj);
                    image.set({
                        left: canvas1.width / 4,
                        top: canvas1.height / 4,
                        angle: 0,
                        padding: 10,
                        cornersize: 10,
                        scaleY: canvas1.width / (image.width * 4),
                        scaleX: canvas1.width / (image.width * 4)
                    });
                    canvas1.add(image);
                }
            }
            reader.readAsDataURL(e.target.files[0]);
        }
        $("#create").click(function(){
          event.preventDefault();
          var canvas = document.getElementById('c1');
          doomslayer = canvas.toDataURL("image/png");
          /*localStorage.setItem('imgCanvas', doomslayer);
          console.log("Save completed");
          window.open('index.html');*/
          //console.log("OKKK");
          //uploadCanvasAsImage();
          (function () {
            if (WebViewBridge) {

              WebViewBridge.onMessage = function (message) {
                objectInfo = JSON.parse(message);

                //Upload stuffs here

                uploadCanvasAsImage(objectInfo);


                WebViewBridge.send("got the message inside webview");
              };

              WebViewBridge.send("hello from webview");
            }
          }());


        });

        function canvasToBlob(canvas, type) {
          var byteString = atob(canvas.toDataURL().split(",")[1]),
            ab = new ArrayBuffer(byteString.length),
            ia = new Uint8Array(ab),
            i;

          for (i = 0; i < byteString.length; i++) {
            ia[i] = byteString.charCodeAt(i);
          }

          return new Blob([ab], {
            type: type
          });
        }


        function uploadCanvasAsImage(objectInfo) {
          var data = new FormData();
          var time = new Date();
          var stickerName = objectInfo.user_id.toString() + time.toString();
          var blob = this.canvasToBlob(canvas1, 'image/png');
          data.append("blob", blob);
          data.append("blob", blob, stickerName);
          data.append("name", stickerName);
          //alert(objectInfo.user_id.toString() + time.toString());
          data.append("blobType", 'image/jpeg');
          this.uploadToServer(data);
          var price = 5;
          listSticker.forEach(function (sticker) {
            //alert(sticker.sticker_price);
            price += sticker.sticker_price;
          });
          //alert(price);

          $.ajax({
            type: "PATCH",
            url:  baseURL + '/Products/' + objectInfo.product_id,
            data: {
              imgList: [
                baseURL + '/containers/container1/download/' + stickerName,
                listShirt
              ],
              price: price
            }
          }).done(function( content ) {
            //alert("OKKKK");
            var data = listSticker;
            $.ajax({
              type: "POST",
              url: baseURL + '/stickers/createSticker?data=' + JSON.stringify(data)
            }).done(function (list) {
              //alert(JSON.stringify(list));
            });

          });

        }

        function uploadToServer(formData) {
          xhr = new XMLHttpRequest();
          xhr.open("post", baseURL + "/containers/container1/upload", true);
          xhr.onreadystatechange = function() {
            if (xhr.readyState == 4) {
              //alert(xhr.responseText);
              $.MessageBox("Product was created successfully");
            }
          };
          xhr.send(formData);
        }

        function readFile(file) {
          var reader = new FileReader();

          reader.onloadend = function () {
            processFile(reader.result, file.type);
          }

          reader.onerror = function () {
            $.MessageBox('There was an error reading the file!');
          }

          reader.readAsDataURL(file);
        }

        function processFile(dataURL, fileType) {
          var maxWidth = 800;
          var maxHeight = 800;

          var image = new Image();
          image.src = dataURL;

          image.onload = function () {
            var width = image.width;
            var height = image.height;
            var shouldResize = (width > maxWidth) || (height > maxHeight);

            //if (!shouldResize) {
              //sendFile(dataURL);
              //return;
            //}

            var newWidth;
            var newHeight;

            if (width > height) {
              newHeight = height * (maxWidth / width);
              newWidth = maxWidth;
            } else {
              newWidth = width * (maxHeight / height);
              newHeight = maxHeight;
            }

            //var canvas = document.createElement('canvas');

            canvas1.width = newWidth;
            canvas1.height = newHeight;

            //dataURL = canvas1.toDataURL(fileType);

            //sendFile(dataURL);
          };

          fabric.Image.fromURL(dataURL, function(img) {
                img.set({
                    left: canvas1.width / 4,
                    top: canvas1.height / 4,
                    angle: 0,
                    padding: 10,
                    cornersize: 10,
                    scaleY: canvas1.width / (img.width * 4),
                    scaleX: canvas1.width / (img.width * 4)
                });
                canvas1.add(img);
            });

          image.onerror = function () {
            $.MessageBox('There was an error processing your file!');
          };
        }




    </script>

  </body>

</html>
